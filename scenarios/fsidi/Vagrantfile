# This file is largely generated by GPT-4o/Claude.
#
# The following setup is done:
#
# - Create a new user with credentials user:user that is automatically logged in
# - Disable BitLocker, if enabled (it shouldn't be)
# - Copy agent.exe from the host to the guest
# - Allow all inbound and outbound traffic to agent.exe through Windows Firewall
# - Disable Windows Time synchronization and use only BIOS/hardware clock
# - Run agent.exe on startup
# - Disable Microsoft Edge SmartScreen and download warnings

# Required plugins:
# vagrant plugin install vagrant-vbguest

Vagrant.configure("2") do |config|
  config.vm.box = "gusztavvargadr/windows-11"
  config.vm.communicator = "winrm"
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"

  config.vm.provider "virtualbox" do |vb|
    vb.gui = true
    vb.memory = 4096
    vb.customize ["modifyvm", :id, "--vram", "128"]
  end    

  # First network interface (NAT) is default
  # Second network interface (host-only)
  config.vm.network "private_network", ip: "192.168.50.4"

  # Create a new user
  config.vm.provision "shell", inline: <<-SHELL
    New-LocalUser -Name "user" -Password (ConvertTo-SecureString "user" -AsPlainText -Force)
    Add-LocalGroupMember -Group "Administrators" -Member "user"
    
    # Set the password to never expire
    Set-LocalUser -Name "user" -PasswordNeverExpires $true
    
    Write-Host "User 'user' created with password that never expires"
  SHELL
  
  # Configure automatic login for the user
  config.vm.provision "shell", inline: <<-SHELL
    # Set registry keys for auto-login
    $RegPath = "HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon"
    Set-ItemProperty -Path $RegPath -Name "AutoAdminLogon" -Value "1" -Type String
    Set-ItemProperty -Path $RegPath -Name "AutoLogonCount" -Value "1" -Type String
    Set-ItemProperty -Path $RegPath -Name "DefaultUsername" -Value "user" -Type String
    Set-ItemProperty -Path $RegPath -Name "DefaultPassword" -Value "user" -Type String
    
    # Disable the lock screen
    $RegPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\Personalization"
    if (-not (Test-Path $RegPath)) {
        New-Item -Path $RegPath -Force | Out-Null
    }
    Set-ItemProperty -Path $RegPath -Name "NoLockScreen" -Value 1 -Type DWord
    
    # Disable require sign-in when PC wakes
    $RegPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Power\\PowerSettings\\0e796bdb-100d-47d6-a2d5-f7d2daa51f51"
    if (-not (Test-Path $RegPath)) {
        New-Item -Path $RegPath -Force | Out-Null
    }
    Set-ItemProperty -Path $RegPath -Name "ACSettingIndex" -Value 0 -Type DWord
    Set-ItemProperty -Path $RegPath -Name "DCSettingIndex" -Value 0 -Type DWord
    
    Write-Host "Automatic login configured for user 'user'"
  SHELL

  # Disable BitLocker encryption
  config.vm.provision "shell", inline: <<-SHELL
    # Disable BitLocker on the C: drive if it's enabled
    $BitLockerStatus = Get-BitLockerVolume -MountPoint "C:" -ErrorAction SilentlyContinue
    if ($BitLockerStatus -and $BitLockerStatus.ProtectionStatus -eq "On") {
      Write-Host "Disabling BitLocker on C: drive..."
      Disable-BitLocker -MountPoint "C:"
    } else {
      Write-Host "BitLocker is not enabled on C: drive. No action needed."
    }

    # Disable BitLocker auto-encryption for new drives
    $path = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\FVE"
    if (-not (Test-Path $path)) {
      New-Item -Path $path -Force | Out-Null
    }
    Set-ItemProperty -Path $path -Name "DisableDeviceEncryption" -Value 1 -Type DWord -Force
    
    # Disable BitLocker service
    Set-Service -Name "BDESVC" -StartupType Disabled
  SHELL

  # Copy agent.exe from host to guest
  # TODO: Download from latest GitHub release instead of copying from host
  config.vm.provision "file", source: "dist/__init__.exe", destination: "C:/agent.exe"

  # Run agent.exe on user login instead of system startup (makes the console visible)
  config.vm.provision "shell", inline: <<-SHELL
    # Create a scheduled task that runs when user logs in
    $action = New-ScheduledTaskAction -Execute "C:\\agent.exe"
    
    # Trigger on user logon
    $trigger = New-ScheduledTaskTrigger -AtLogOn -User "user"
    
    # Create task with user's credentials
    $principal = New-ScheduledTaskPrincipal -UserId "user" -LogonType Interactive -RunLevel Highest
    
    # Register the task with these settings
    Register-ScheduledTask -TaskName "AgentStartup" -Action $action -Trigger $trigger -Principal $principal -Force
    
    Write-Host "Agent scheduled to run when user 'user' logs in"
  SHELL

  # Place agent.exe in the user's startup folder
  # config.vm.provision "shell", inline: <<-SHELL
  #   # Ensure the startup folder exists
  #   $startupFolder = "C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"
  #   if (-not (Test-Path $startupFolder)) {
  #     New-Item -Path $startupFolder -ItemType Directory -Force | Out-Null
  #     Write-Host "Created startup folder: $startupFolder"
  #   }
    
  #   # Copy agent.exe to the startup folder
  #   Copy-Item -Path "C:\\agent.exe" -Destination "$startupFolder\\agent.exe" -Force
  #   Write-Host "Copied agent.exe to user's startup folder"
    
  #   # Set appropriate permissions
  #   icacls "$startupFolder\\agent.exe" /grant "user:(RX)" /C
  #   Write-Host "Set permissions for agent.exe in startup folder"
  # SHELL

  # Allow all inbound and outbound traffic to agent.exe through Windows Firewall
  config.vm.provision "shell", inline: <<-SHELL
    New-NetFirewallRule -DisplayName "Allow inbound traffic to agent.exe" -Direction Inbound -Program "C:\\agent.exe" -Action Allow
    New-NetFirewallRule -DisplayName "Allow outbound traffic to agent.exe" -Direction Outbound -Program "C:\\agent.exe" -Action Allow
    New-NetFirewallRule -DisplayName "Allow inbound traffic to agent.exe in startup folder" -Direction Inbound -Program "C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\agent.exe" -Action Allow
    New-NetFirewallRule -DisplayName "Allow outbound traffic to agent.exe in startup folder" -Direction Outbound -Program "C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\agent.exe" -Action Allow
  SHELL

  # Run agent.exe when the machine is first run
  # config.vm.provision "shell", inline: <<-SHELL
  #   Start-Process -FilePath "C:\\agent.exe"
  # SHELL
  
  # Disable Windows Time Synchronization and use only BIOS/hardware clock
  config.vm.provision "shell", inline: <<-SHELL
    Write-Host "Disabling Windows Time synchronization services..."
    
    # Stop and disable the Windows Time service
    Stop-Service -Name "W32Time" -Force
    Set-Service -Name "W32Time" -StartupType Disabled
    
    # Disable automatic time sync via registry
    $timeZoneKey = "HKLM:\\SYSTEM\\CurrentControlSet\\Services\\tzautoupdate"
    if (Test-Path $timeZoneKey) {
      Set-ItemProperty -Path $timeZoneKey -Name "Start" -Value 4
    }
    
    # Disable all internet time synchronization
    $internetTimeKey = "HKLM:\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\Parameters"
    if (Test-Path $internetTimeKey) {
      Set-ItemProperty -Path $internetTimeKey -Name "Type" -Value "NoSync"
    }
    
    # Disable automatic time zone updates
    $timeSettingsKey = "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\CapabilityAccessManager\\ConsentStore\\location"
    if (Test-Path $timeSettingsKey) {
      Set-ItemProperty -Path $timeSettingsKey -Name "Value" -Value "Deny" -Type String
    }
    
    # Disable "Set time automatically" and "Set time zone automatically" in Settings
    $autoTimeKey = "HKLM:\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\Parameters"
    if (Test-Path $autoTimeKey) {
      New-ItemProperty -Path $autoTimeKey -Name "NtpServer" -Value "" -PropertyType String -Force
    }
    
    $timeSettings = "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\DateTime\\Servers"
    if (Test-Path $timeSettings) {
      Set-ItemProperty -Path $timeSettings -Name "(Default)" -Value "0" -Type String
    }
    
    Write-Host "Windows Time synchronization has been disabled. System will now rely only on BIOS/hardware clock."
  SHELL

  # Disable Microsoft Edge SmartScreen and download warnings
  config.vm.provision "shell", inline: <<-SHELL
    Write-Host "Disabling Microsoft Edge SmartScreen and download warnings..."
    
    # Create Edge policy directory if it doesn't exist
    $edgePolicyPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Edge"
    if (-not (Test-Path $edgePolicyPath)) {
      New-Item -Path $edgePolicyPath -Force | Out-Null
    }
    
    # Disable SmartScreen for Edge
    Set-ItemProperty -Path $edgePolicyPath -Name "SmartScreenEnabled" -Value 0 -Type DWord
    
    # Disable SmartScreen for file downloads
    Set-ItemProperty -Path $edgePolicyPath -Name "SmartScreenForTrustedDownloadsEnabled" -Value 0 -Type DWord
    
    # Disable download warning prompts
    Set-ItemProperty -Path $edgePolicyPath -Name "PreventSmartScreenPromptOverride" -Value 0 -Type DWord
    Set-ItemProperty -Path $edgePolicyPath -Name "PreventSmartScreenPromptOverrideForFiles" -Value 0 -Type DWord
    
    # Disable automatic file blocking
    Set-ItemProperty -Path $edgePolicyPath -Name "AutomaticFileDownloadsBlocked" -Value 0 -Type DWord
    
    # Configure download settings
    Set-ItemProperty -Path $edgePolicyPath -Name "PromptForDownloadLocation" -Value 0 -Type DWord
    
    # Also disable Windows Defender SmartScreen
    $smartScreenPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\System"
    if (-not (Test-Path $smartScreenPath)) {
      New-Item -Path $smartScreenPath -Force | Out-Null
    }
    Set-ItemProperty -Path $smartScreenPath -Name "EnableSmartScreen" -Value 0 -Type DWord
    
    # Disable SmartScreen in Internet Explorer as well (since it can affect Edge)
    $ieSmartScreenPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Internet Explorer\\PhishingFilter"
    if (-not (Test-Path $ieSmartScreenPath)) {
      New-Item -Path $ieSmartScreenPath -Force | Out-Null
    }
    Set-ItemProperty -Path $ieSmartScreenPath -Name "EnabledV9" -Value 0 -Type DWord
    
    Write-Host "Microsoft Edge security warnings for downloads have been disabled."
  SHELL

  # Restart the virtual machine after provisioning is complete
  config.vm.provision "shell", inline: <<-SHELL
    Write-Host "All configuration completed. Restarting the virtual machine..."
    # Schedule a restart in 10 seconds to allow Vagrant to finish provisioning
    shutdown /r /t 10 /f /c "Restarting after initial configuration"
  SHELL
end